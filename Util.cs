using Godot;
using System.Collections.Generic;
using System.Linq;
using System.Text;

public class Util {

    // Gets UTF32 chars    
    public static List<string> Chars(string s) {
        var bytes = Encoding.UTF32.GetBytes(s);
        var list = new List<string>();
        for (int i = 0; i < bytes.Length; i += 4) {
            list.Add(char.ConvertFromUtf32(bytes[i] | bytes[i + 1] << 8 | bytes[i + 2] << 16 | bytes[i + 3] << 24));
        }
        return list;
    }

    public const string Yi = "\U0001b006";
    public const string Ye = "\U0001b001";
    public const string Wu = "\U0001b11f";
    public const string YI = "\U0001b120";
    public const string YE = "\U0001b121";
    public const string WU = "\U0001b122";
    public static readonly Dictionary<string, ulong> SegmentMap = new Dictionary<string, ulong>() {
        //       44   40   36   32   28   24   20   16   12    8    4    0
        {"ア", 0b00_0000_0000_0000_0000_0000_0000_0001_0000_0000_0001_1100},
        {"イ", 0b00_0000_0000_0000_0000_0000_0000_0000_0010_0011_0000_0000},
        {"ウ", 0b00_0000_0000_0000_0000_0000_0000_0011_0000_0000_0101_1010},
        {"エ", 0b00_0000_0000_0000_0000_0001_1000_0000_0000_0011_1001_1000},
        {"オ", 0b00_0000_0000_0000_0000_0000_0000_0011_0001_1100_0011_1000},
        {"カ", 0b00_0000_0000_0000_0000_0000_0000_0010_1101_0001_1000_0000},
        {"キ", 0b00_0000_0000_0000_0000_0000_0000_0000_1100_0011_1101_1000},
        {"ク", 0b00_0000_0000_0000_0000_0000_0000_0011_0000_0000_0001_1011},
        {"ケ", 0b00_0000_0000_0000_0000_0000_0000_0000_0000_0011_1001_1011},
        {"コ", 0b00_0000_0000_0000_0000_0001_1000_0000_0001_1000_0001_1000},
        {"サ", 0b00_0000_0000_0000_0000_0000_0000_0000_0001_1101_1111_1000},
        {"シ", 0b00_0000_0000_0000_0000_0001_1000_0000_0101_0000_0000_1000},
        {"ス", 0b00_0000_0000_0000_0000_0000_0110_0011_0000_0000_0001_1000},
        {"セ", 0b00_0000_0000_0000_0000_0001_0000_0000_0010_1011_1000_0000},
        {"ソ", 0b00_0000_0000_0000_0000_0000_0000_0011_0000_0000_0000_0010},
        {"タ", 0b00_0000_0000_0000_0000_0000_0011_0011_0000_0000_0001_1011},
        {"チ", 0b00_0000_0000_0000_0000_0000_0000_0000_1110_0011_0000_0000},
        {"ツ", 0b00_0000_0000_0000_0000_0001_0000_0000_0001_1001_1000_0010},
        {"テ", 0b00_0000_0000_0000_0000_0000_0000_0000_1100_0010_0001_1000},
        {"ト", 0b00_0000_0000_0000_0000_0000_0000_0000_1100_0000_0000_0110},
        {"ナ", 0b00_0000_0000_0000_0000_0000_0000_0010_1100_0001_1000_0000},
        {"ニ", 0b00_0000_0000_0000_0000_0001_1000_0000_0000_0000_0001_1000},
        {"ヌ", 0b00_0000_0000_0000_0000_0000_0011_0011_0000_0000_0001_1000},
        {"ネ", 0b00_0000_0000_0000_0000_0000_0110_0011_0000_0010_0101_1000},
        {"ノ", 0b00_0000_0000_0000_0000_0000_0000_0011_0000_0000_0000_0000},
        //       44   40   36   32   28   24   20   16   12    8    4    0
        {"ハ", 0b00_0000_0000_0000_0000_0000_0000_0000_0001_1000_0000_0110},
        {"ヒ", 0b00_0000_0000_0000_0000_0001_1000_0000_1100_0000_0000_0110},
        {"フ", 0b00_0000_0000_0000_0000_0000_0000_0011_0000_0000_0001_1000},
        {"ヘ", 0b00_0000_0000_0000_0000_0000_0111_1000_0000_0000_0000_0010},
        {"ホ", 0b00_0000_0000_0000_0000_0000_0000_0000_0001_0011_1101_1100},
        {"マ", 0b00_0000_0000_0000_0000_0000_0111_0001_0000_0000_0001_1000},
        {"ミ", 0b00_0000_0000_0000_0000_0001_1000_0000_1100_0000_0001_1000},
        {"ム", 0b00_0000_0000_0000_0000_0001_1000_0011_0001_0000_0000_0000},
        {"メ", 0b00_0000_0000_0000_0000_0000_0011_0011_0000_0000_0000_0000},
        {"モ", 0b00_0000_0000_0000_0000_0001_0000_0000_1100_0011_0001_1000},
        {"ヤ", 0b00_0000_0000_0000_0000_0000_0000_0001_0010_0011_1000_0000},
        {YI,   0b00_0000_0000_0000_0000_0001_1000_0000_0000_0011_1000_0000},
        {"ユ", 0b00_0000_0000_0000_0000_0001_1000_0000_0000_0011_1000_1000},
        {YE,   0b00_0000_0000_0000_0000_0001_1000_0000_0010_0011_0000_0000},
        {"ヨ", 0b00_0000_0000_0000_0000_0001_1000_0000_1101_1000_0001_1000},
        {"ラ", 0b00_0000_0000_0000_0000_0000_0000_0100_1100_0000_0001_1000},
        {"リ", 0b00_0000_0000_0000_0000_0001_0000_0000_0001_1000_0000_0010},
        {"ル", 0b00_0000_0000_0000_0000_0000_0000_0100_0000_0011_1000_0110},
        {"レ", 0b00_0000_0000_0000_0000_0000_1000_0100_0000_0000_0000_0110},
        {"ロ", 0b00_0000_0000_0000_0000_0001_1000_0000_0001_1000_0001_1110},
        {"ワ", 0b00_0000_0000_0000_0000_0000_0000_0011_0000_0000_0001_1010},
        {"ヰ", 0b00_0000_0000_0000_0000_0000_0000_0000_1100_0011_1101_1010},
        {WU,   0b00_0000_0000_0000_0000_0000_1000_0000_1100_0011_1001_1000},
        {"ヱ", 0b00_0000_0000_0000_0000_0001_1000_0001_0000_0011_1001_1000},
        {"ヲ", 0b00_0000_0000_0000_0000_0000_0000_0011_0100_0000_0001_1000},
        {"ン", 0b00_0000_0000_0000_0000_0000_0000_0011_0000_0000_0000_1000},
        {"゛", 0b00_0000_0000_0000_0000_1010_0000_0000_0000_0000_0000_0000},
        {"゜", 0b00_0000_0000_0000_0001_1110_0000_0000_0000_0000_0000_0000},
        {"ー", 0b00_0000_0000_0000_0000_0000_0000_0000_0000_0011_1000_0000},
        {"＝", 0b00_0000_0000_0000_0000_0000_0000_0000_0001_1011_1000_0000},
        //       44   40   36   32   28   24   20   16   12    8    4    0
        {"ァ", 0b00_0100_0000_0001_1100_0000_0000_0000_0000_0000_0000_0000},
        {"ィ", 0b00_0101_0001_0000_0000_0000_0000_0000_0000_0000_0000_0000},
        {"ゥ", 0b00_1100_0000_0101_1010_0000_0000_0000_0000_0000_0000_0000},
        {"ェ", 0b11_0000_0001_1001_1000_0000_0000_0000_0000_0000_0000_0000},
        {"ォ", 0b00_1100_1110_0011_1000_0000_0000_0000_0000_0000_0000_0000},
        {"ャ", 0b00_0100_0001_1101_1000_0000_0000_0000_0000_0000_0000_0000},
        {"ュ", 0b11_0000_0001_1000_1000_0000_0000_0000_0000_0000_0000_0000},
        {"ョ", 0b11_0011_1100_0001_1000_0000_0000_0000_0000_0000_0000_0000},
        {"ヮ", 0b00_1100_0000_0001_1010_0000_0000_0000_0000_0000_0000_0000},
        {"ッ", 0b10_0000_1100_1000_0010_0000_0000_0000_0000_0000_0000_0000},
         
        {"０", 0b00_0000_0000_0000_0000_0001_1000_0000_0001_1001_0001_1110},
        {"１", 0b00_0000_0000_0000_0000_0001_1000_0000_0000_0011_1100_1000},
        {"２", 0b00_0000_0000_0000_0000_0001_1000_0000_1100_1000_0001_1100},
        {"３", 0b00_0000_0000_0000_0000_0001_1000_0000_1001_1000_0001_1000},
        {"４", 0b00_0000_0000_0000_0000_0000_0000_0000_1101_1000_0000_0010},
        {"５", 0b00_0000_0000_0000_0000_0001_1000_0000_1101_0000_0001_1010},
        {"６", 0b00_0000_0000_0000_0000_0001_1000_0000_1101_0000_0001_1110},
        {"７", 0b00_0000_0000_0000_0000_0000_0000_0001_0000_0010_0001_1000},
        {"８", 0b00_0000_0000_0000_0000_0001_1000_0000_1101_1000_0001_1110},
        {"９", 0b00_0000_0000_0000_0000_0001_1000_0000_1101_1000_0001_1010},
         
        {"Ａ", 0b00_0000_0000_0000_0000_0000_0000_0000_1101_1000_0001_1110},
        {"Ｂ", 0b00_0000_0000_0000_0000_0001_1000_0000_1001_1011_1001_1000},
        {"Ｃ", 0b00_0000_0000_0000_0000_0001_1000_0000_0000_0000_0001_1110},
        {"Ｄ", 0b00_0000_0000_0000_0000_0001_1000_0000_0001_1011_1001_1000},
        {"Ｅ", 0b00_0000_0000_0000_0000_0001_1000_0000_1100_0000_0001_1110},
        {"Ｆ", 0b00_0000_0000_0000_0000_0000_0000_0000_1100_0000_0001_1110},
        {"Ｇ", 0b00_0000_0000_0000_0000_0001_1000_0000_1001_0000_0001_1110},
        {"Ｈ", 0b00_0000_0000_0000_0000_0000_0000_0000_1101_1000_0000_0110},
        {"Ｉ", 0b00_0000_0000_0000_0000_0001_1000_0000_0000_0011_1101_1000},
        {"Ｊ", 0b00_0000_0000_0000_0000_0000_1000_0000_0000_0011_1001_1000},
        {"Ｋ", 0b00_0000_0000_0000_0000_0000_0110_0001_0100_0000_0000_0110},
        {"Ｌ", 0b00_0000_0000_0000_0000_0001_1000_0000_0000_0000_0000_0110},
        {"Ｍ", 0b00_0000_0000_0000_0000_0000_0001_1001_0001_1010_0000_0110},
        {"Ｎ", 0b00_0000_0000_0000_0000_0000_0111_1000_0001_1000_0000_0110},
        {"Ｏ", 0b00_0000_0000_0000_0000_0000_1000_0100_0000_1000_0001_1110},
        {"Ｐ", 0b00_0000_0000_0000_0000_0000_0000_0000_1100_1000_0001_1110},
        {"Ｑ", 0b00_0000_0000_0000_0000_0000_1110_0100_0000_1000_0001_1110},
        {"Ｒ", 0b00_0000_0000_0000_0000_0000_0110_0000_1100_1000_0001_1110},
        {"Ｓ", 0b00_0000_0000_0000_0000_0001_1111_1000_0000_0000_0001_1000},
        {"Ｔ", 0b00_0000_0000_0000_0000_0000_0000_0000_0000_0011_1001_1000},
        {"Ｕ", 0b00_0000_0000_0000_0000_0001_1000_0000_0001_1000_0000_0110},
        {"Ｖ", 0b00_0000_0000_0000_0000_0000_0000_0011_0000_0000_0000_0110},
        {"Ｗ", 0b00_0000_0000_0000_0000_0000_0110_0010_0001_1000_0000_0110},
        {"Ｘ", 0b00_0000_0000_0000_0000_0000_0111_1011_0000_0000_0000_0000},
        {"Ｙ", 0b00_0000_0000_0000_0000_0000_0001_1011_0000_0000_0000_0000},
        {"Ｚ", 0b00_0000_0000_0000_0000_0001_1000_0011_0000_0000_0001_1000},

        {"ａ", 0b00_0000_0000_0000_0000_0001_0000_0100_1001_0000_0000_0000},
        {"ｂ", 0b00_0000_0000_0000_0000_0001_0000_0000_1001_0011_1000_0000},
        {"ｃ", 0b00_0000_0000_0000_0000_0001_0000_0000_1000_0010_0000_0000},
        {"ｄ", 0b00_0000_0000_0000_0000_0001_0000_0000_1001_1010_0000_0000},
        {"ｅ", 0b00_0000_0000_0000_0000_0001_0000_0100_1000_0010_0000_0000},
        {"ｆ", 0b00_0000_0000_0000_0000_0000_0000_0000_1000_0011_1001_0000},
        {"ｇ", 0b00_0000_0000_0000_0000_0001_0000_0000_1001_1001_1001_0000},
        {"ｈ", 0b00_0000_0000_0000_0000_0000_0000_0000_1001_0011_1000_0000},
        {"ｉ", 0b00_0000_0000_0000_0000_0000_0000_0000_0000_0010_1000_0000},
        {"ｊ", 0b00_0000_0000_0000_0000_0000_1000_0000_0000_0010_1000_0000},
        {"ｋ", 0b00_0000_0000_0000_0000_0000_0110_0000_1000_0011_1000_0000},
        {"ｌ", 0b00_0000_0000_0000_0000_0001_0000_0000_0000_0011_1000_0000},
        {"ｍ", 0b00_0000_0000_0000_0000_0000_0000_0000_1101_0010_0000_0100},
        {"ｎ", 0b00_0000_0000_0000_0000_0000_0000_0000_1001_0010_0000_0000},
        {"ｏ", 0b00_0000_0000_0000_0000_0001_0000_0000_1001_0010_0000_0000},
        {"ｐ", 0b00_0000_0000_0000_0000_0000_0000_0000_1000_1011_1001_0000},
        {"ｑ", 0b00_0000_0000_0000_0000_0000_0000_0000_1001_1001_1001_0000},
        {"ｒ", 0b00_0000_0000_0000_0000_0000_0000_0000_1000_0010_0000_0000},
        {"ｓ", 0b00_0000_0000_0000_0000_0001_0110_0000_1000_0000_0000_0000},
        {"ｔ", 0b00_0000_0000_0000_0000_0001_0000_0000_1000_0011_1000_0000},
        {"ｕ", 0b00_0000_0000_0000_0000_0001_0000_0000_0001_0010_0000_0000},
        {"ｖ", 0b00_0000_0000_0000_0000_0000_0000_0100_0000_0010_0000_0000},
        {"ｗ", 0b00_0000_0000_0000_0000_0000_0110_0010_0001_0000_0000_0100},
        {"ｘ", 0b00_0000_0000_0000_0000_0000_0110_0100_0000_0000_0000_0000},
        {"ｙ", 0b00_0000_0000_0000_0000_0000_0000_0100_1000_1001_1000_0000},
        {"ｚ", 0b00_0000_0000_0000_0000_0001_0000_0100_1000_0000_0000_0000},

        {"。", 0b00_0000_0000_0000_0000_0000_0000_0000_1000_1001_1001_0000},
        {"、", 0b00_0000_0000_0000_0000_0000_0110_0000_0000_0000_0000_0000},
        {"（", 0b00_0000_0000_0000_0000_0000_0000_0010_1001_0000_0000_0000},
        {"）", 0b00_0000_0000_0000_0000_0000_0000_0001_0100_0000_0000_0010},
        {"［", 0b00_0000_0000_0000_0000_0000_0000_0000_1101_0000_0000_0100},
        {"］", 0b00_0000_0000_0000_0000_0000_0000_0000_1100_1000_0000_0010},
        {"｛", 0b00_0000_0000_0000_0000_0000_0000_0000_1101_0001_1000_0100},
        {"｝", 0b00_0000_0000_0000_0000_0000_0000_0000_1100_1010_0000_0010},
        {"「", 0b00_0000_0000_0000_0000_0000_0000_0000_1001_0000_0000_0000},
        {"」", 0b00_0000_0000_0000_0000_0000_0000_0000_0100_0000_0000_0010},
        {"『", 0b00_0000_0000_0000_0000_0001_0000_0000_0101_1010_0001_1010},
        {"』", 0b00_0000_0000_0000_0000_0001_1000_0000_1001_0001_1000_1110},
        {"・", 0b00_0000_0000_0000_0000_0000_0000_0000_0000_0001_0000_0000},
        {"〈", 0b00_0000_0000_0000_0000_0000_0110_0010_0000_0000_0000_0000},
        {"〉", 0b00_0000_0000_0000_0000_0000_0001_1001_0000_0000_0000_0000},
        {"※", 0b00_0000_0000_0000_0000_0000_0111_1011_0000_0000_1000_0000},
        {"〜", 0b00_0000_0000_0000_0000_0000_0000_0101_1000_0000_0000_0000},
        {"！", 0b00_0000_0000_0000_0000_0000_0000_0000_0000_0010_1100_0000},
        {"？", 0b00_0000_0000_0000_0000_0000_0000_0000_1000_1010_0001_1000},

        {"　", 0b00_0000_0000_0000_0000_0000_0000_0000_0000_0000_0000_0000},

        {Pending, PendingBitfield},
    };

    public const ulong CursorBitfield = 0b00_0000_0000_0000_0000_0000_0000_0000_0000_0000_0001_1000;
    public const ulong SuteganaCursorBitfield = 0b00_0000_0000_0001_1000_0000_0000_0000_0000_0000_0000_0000;
    public const string Pending = "_";
    public const ulong PendingBitfield = 0b00_0000_0000_0000_0000_0010_0000_0000_0000_0000_0000_0000;

    static Dictionary<string, string> NormalizationMapFunc() {
        string hankaku = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-=.,()[]{}·<>~!? ";
        string zenkaku = "ＡＢＣＤＥＦＧＨＩＪＫＬＭＮＯＰＱＲＳＴＵＶＷＸＹＺａｂｃｄｅｆｇｈｉｊｋｌｍｎｏｐｑｒｓｔｕｖｗｘｙｚ０１２３４５６７８９" +
            "ー＝。、（）［］｛｝・〈〉〜！？　";

        string withDakuten = "ガギグゲゴザジズゼゾダヂヅデドバビブベボヷヸヹヺヴ";
        string withoutDakuten = "カキクケコサシスセソタチツテトハヒフヘホワヰヱヲウ";

        string withHandakuten = "パピプペポ";
        string withoutHandakuten = "ハヒフヘホ";

        string extraA = "゙゚\"\'＜＞";
        string extraB = "゛゜゛゜〈〉";

        string hiragana = $"あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもや{Yi}ゆ{Ye}よらりるれろわゐ{Wu}ゑをん" +
            $"がぎぐげござじずぜぞだぢづでどばびぶべぼゔぱぴぷぺぽ" +
            $"ぁぃぅぇぉゃゅょゎっ";
        string katakana = $"アイウエオカキクケコサシスセソタチツテトナニヌネノハヒフヘホマミムメモヤ{YI}ユ{YE}ヨラリルレロワヰ{WU}ヱヲン" +
            $"ガギグゲゴザジズゼゾダヂヅデドバビブベボヴパピプペポ" +
            $"ァィゥェォャュョヮッ";

        var dict = Chars(hankaku).Zip(Chars(zenkaku), (a, b) => (a, b))
            .Concat(Chars(withDakuten).Zip(Chars(withoutDakuten), (a, b) => (a, $"{b}゛")))
            .Concat(Chars(withHandakuten).Zip(Chars(withoutHandakuten), (a, b) => (a, $"{b}゜")))
            .Concat(Chars(extraA).Zip(Chars(extraB), (a, b) => (a, b)))
            .Concat(Chars(hiragana).Zip(Chars(katakana), (a, b) => (a, b)))
            .ToDictionary(pair => $"{pair.Item1}", pair => $"{pair.Item2}");
        var prevDict = new Dictionary<string, string>(dict);
        foreach (var key in prevDict.Keys) {
            if (prevDict.ContainsKey(prevDict[key]))
                dict[key] = prevDict[prevDict[key]]; // Sometimes you need both hiragana->katanana and dakuten separation.
        }

        return dict;
    }

    public static readonly Dictionary<string, string> NormalizationMap = NormalizationMapFunc();

    public static readonly HashSet<string> Dakuten =  Chars("゛゜").ToHashSet();
    public static readonly HashSet<string> Sutegana = Chars("ァィゥェォャュョヮッ").ToHashSet();
    public static readonly HashSet<string> Lowercase = Chars("ａｂｃｄｅｆｇｈｉｊｋｌｍｎｏｐｑｒｓｔｕｖｗｘｙｚ").ToHashSet();
}